{{/* Navigation menu partial with hierarchical support and external link handling */}}
{{- $currentPage := . }}
{{- $isMobile := false }}
{{- if reflect.IsMap . }}
{{- if .context }}
{{- $currentPage = .context }}
{{- end }}
{{- if .mobile }}
{{- $isMobile = .mobile }}
{{- end }}
{{- end }}

{{- with site.Menus.main }}
<div class="nav-menu">
  {{- range . }}
  {{- if not .Parent }}
  {{- $hasChildren := .HasChildren }}
  {{- $isExternal := strings.HasPrefix .URL "http" }}
  {{- $isActive := false }}
  {{- $isAncestor := false }}

  {{/* Check if current page matches this menu item */}}
  {{- if $currentPage.IsMenuCurrent .Menu . }}
  {{- $isActive = true }}
  {{- else if $currentPage.HasMenuCurrent .Menu . }}
  {{- $isAncestor = true }}
  {{- end }}

  <div class="nav-item{{ if $hasChildren }} nav-item-dropdown{{ end }}">
    {{/* Main menu link */}}
    <a href="{{ .URL | relURL }}" {{- if $isExternal }} {{- with .Params.target }} target="{{ . }}" {{ else }}
      target="_blank" {{ end }} {{- with .Params.rel }} rel="{{ . }}" {{ else }} rel="external noopener noreferrer" {{
      end }} {{- end }} {{- if $isActive }} class="nav-link active focus-visible" aria-current="page" {{- else if
      $isAncestor }} class="nav-link ancestor focus-visible" aria-current="true" {{- else }}
      class="nav-link focus-visible" {{- end }} {{- if $hasChildren }} aria-haspopup="true" aria-expanded="false" 
      aria-describedby="submenu-{{ .Name | urlize }}-desc" role="button" {{- end }}
      {{- if $hasChildren }} tabindex="0" {{- end }}>
      {{ .Name }}
      {{- if $isExternal }}
      <svg style="width: 0.875rem; height: 0.875rem; margin-left: var(--space-1);" fill="none" stroke="currentColor"
        viewBox="0 0 24 24" aria-hidden="true" role="img" aria-label="External link">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
      </svg>
      <span class="sr-only">(opens in new tab)</span>
      {{- end }}
      {{- if $hasChildren }}
      <svg class="dropdown-arrow"
        style="width: 0.875rem; height: 0.875rem; margin-left: var(--space-1); transition: transform var(--transition-fast);"
        fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" role="img" aria-label="Submenu indicator">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
      {{- end }}
    </a>
    
    {{- if $hasChildren }}
    <span id="submenu-{{ .Name | urlize }}-desc" class="sr-only">
      Press Enter or Space to expand submenu, use arrow keys to navigate
    </span>
    {{- end }}

    {{/* Dropdown menu for children */}}
    {{- if $hasChildren }}
    <div class="nav-submenu" 
         role="menu" 
         aria-hidden="true" 
         aria-labelledby="nav-{{ .Name | urlize }}"
         id="submenu-{{ .Name | urlize }}">
      {{- range .Children }}
      {{- $childIsExternal := strings.HasPrefix .URL "http" }}
      {{- $childIsActive := false }}

      {{- if $currentPage.IsMenuCurrent .Menu . }}
      {{- $childIsActive = true }}
      {{- end }}

      <a href="{{ .URL | relURL }}" 
         role="menuitem"
         tabindex="-1"
         {{- if $childIsExternal }} {{- with .Params.target }} target="{{ . }}" {{ else }}
         target="_blank" {{ end }} {{- with .Params.rel }} rel="{{ . }}" {{ else }} rel="external noopener noreferrer" {{
         end }} {{- end }} {{- if $childIsActive }} class="nav-sublink active focus-visible" aria-current="page" {{- else
         }} class="nav-sublink focus-visible" {{- end }}>
        {{ .Name }}
        {{- if $childIsExternal }}
        <svg style="width: 0.75rem; height: 0.75rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24"
          aria-hidden="true" role="img" aria-label="External link">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
        <span class="sr-only">(opens in new tab)</span>
        {{- end }}
      </a>
      {{- end }}
    </div>
    {{- end }}
  </div>
  {{- end }}
  {{- end }}
</div>
{{- end }}

{{/* Navigation interaction styles and JavaScript */}}
<style>
  /* Enhanced dropdown menu styles with proper z-index and hover states */
  .nav-desktop .nav-menu {
    display: flex;
    align-items: center;
    gap: var(--space-6);
  }
  
  /* Hide desktop navigation menu on mobile */
  @media (max-width: 768px) {
    .nav-desktop .nav-menu {
      display: none !important;
    }
  }

  .nav-item {
    position: relative;
  }

  .nav-item-dropdown {
    position: relative;
  }

  /* Remove any default button/link styling */
  .nav-item a,
  .nav-item button {
    border: none;
    background: none;
    font-family: inherit;
    font-size: inherit;
    cursor: pointer;
  }

  /* Ensure no unwanted borders or outlines */
  .nav-item *:not(:focus-visible) {
    outline: none !important;
    border: none !important;
  }

  /* Specifically target navigation elements to remove browser defaults */
  .nav-menu a,
  .nav-menu button {
    outline: none !important;
    border: none !important;
    box-shadow: none !important;
  }

  /* Only show focus styles when using keyboard navigation */
  .nav-menu a:focus:not(:focus-visible),
  .nav-menu button:focus:not(:focus-visible) {
    outline: none !important;
    border: none !important;
    box-shadow: none !important;
  }

  /* Navigation link base styles */
  .nav-link {
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: color var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius);
    border: none;
    background: none;
  }

  .nav-link:hover,
  .nav-link:focus {
    color: var(--color-link) !important;
    background-color: var(--color-bg-secondary);
  }

  .nav-link.active,
  .nav-link.ancestor {
    color: var(--color-link) !important;
  }

  /* Override global focus styles for navigation links */
  .nav-link:focus,
  .nav-link.focus-visible:focus {
    outline: none;
    box-shadow: none;
  }

  .nav-link:focus-visible,
  .nav-link.focus-visible:focus-visible {
    outline: 2px solid var(--color-focus);
    outline-offset: 2px;
    border-radius: var(--radius);
  }

  /* Ensure no unwanted focus styles when not using keyboard */
  .nav-link:focus:not(:focus-visible) {
    outline: none;
    box-shadow: none;
  }

  /* Dropdown arrow rotation and visual feedback */
  .nav-link .dropdown-arrow {
    transition: transform var(--transition-fast);
  }

  .nav-item-dropdown:hover .nav-link .dropdown-arrow,
  .nav-item-dropdown:focus-within .nav-link .dropdown-arrow,
  .nav-item-dropdown.dropdown-open .nav-link .dropdown-arrow {
    transform: rotate(180deg);
  }
  
  /* Enhanced visual feedback for dropdown states */
  .nav-item-dropdown.dropdown-open .nav-link {
    background-color: var(--color-bg-secondary);
    color: var(--color-link);
  }
  
  /* Improved submenu positioning and visibility */
  .nav-item-dropdown.dropdown-open .nav-submenu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  /* Submenu base styles */
  .nav-submenu {
    position: absolute;
    top: calc(100% + var(--space-1));
    left: 0;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    padding: var(--space-2);
    min-width: 12rem;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-0.5rem);
    transition: all var(--transition-fast);
  }

  /* Show dropdown on hover and focus */
  .nav-item-dropdown:hover .nav-submenu,
  .nav-item-dropdown:focus-within .nav-submenu,
  .nav-item-dropdown.dropdown-open .nav-submenu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }



  /* Submenu link styles */
  .nav-sublink {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2);
    color: var(--color-text);
    text-decoration: none;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    white-space: nowrap;
    border: none;
    background: none;
    width: 100%;
  }

  .nav-sublink:hover,
  .nav-sublink:focus {
    background-color: var(--color-bg-secondary) !important;
    color: var(--color-link) !important;
  }

  .nav-sublink.active {
    color: var(--color-link) !important;
  }

  /* Override global focus styles for submenu links */
  .nav-sublink:focus,
  .nav-sublink.focus-visible:focus {
    outline: none;
    box-shadow: none;
  }

  .nav-sublink:focus-visible,
  .nav-sublink.focus-visible:focus-visible {
    outline: 2px solid var(--color-focus);
    outline-offset: 2px;
    border-radius: var(--radius-sm);
  }

  /* Ensure no unwanted focus styles when not using keyboard */
  .nav-sublink:focus:not(:focus-visible) {
    outline: none;
    box-shadow: none;
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .mobile-menu .nav-menu {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-3);
      width: 100%;
    }

    .mobile-menu .nav-item {
      width: 100%;
    }

    .mobile-menu .nav-submenu {
      position: static;
      opacity: 1;
      visibility: visible;
      transform: none;
      box-shadow: none;
      border: none;
      background: transparent;
      padding: 0;
      margin-left: var(--space-4);
      margin-top: var(--space-2);
    }

    .mobile-menu .nav-sublink {
      padding: var(--space-1) 0;
    }
  }
</style>

<script>
  // Enhanced navigation functionality with dropdown support
  document.addEventListener('DOMContentLoaded', function () {
    // Mobile menu functionality is handled by mobile-navigation.js

    // Enhanced dropdown menu functionality with improved accessibility
    const dropdownItems = document.querySelectorAll('.nav-item-dropdown');

    dropdownItems.forEach(function (dropdown) {
      const link = dropdown.querySelector('.nav-link[aria-haspopup="true"]');
      const submenu = dropdown.querySelector('.nav-submenu');

      if (link && submenu) {
        // Set initial ARIA attributes
        link.setAttribute('id', 'nav-' + link.textContent.trim().toLowerCase().replace(/\s+/g, '-'));
        submenu.setAttribute('aria-labelledby', link.id);
        
        // Click handling for mobile/touch devices
        link.addEventListener('click', function (event) {
          // Only prevent default on mobile or when dropdown is closed
          if (window.innerWidth <= 768 || !dropdown.classList.contains('dropdown-open')) {
            event.preventDefault();
            toggleDropdown(dropdown, link, submenu);
          }
        });

        // Enhanced keyboard navigation with ARIA support
        link.addEventListener('keydown', function (event) {
          switch (event.key) {
            case 'Enter':
            case ' ':
              event.preventDefault();
              toggleDropdown(dropdown, link, submenu);
              announceToScreenReader(
                dropdown.classList.contains('dropdown-open') 
                  ? 'Submenu opened' 
                  : 'Submenu closed'
              );
              break;
            case 'ArrowDown':
              event.preventDefault();
              openDropdown(dropdown, link, submenu);
              focusFirstSubmenuItem(submenu);
              announceToScreenReader('Submenu opened, navigating to first item');
              break;
            case 'ArrowRight':
              if (!dropdown.classList.contains('dropdown-open')) {
                event.preventDefault();
                openDropdown(dropdown, link, submenu);
                focusFirstSubmenuItem(submenu);
                announceToScreenReader('Submenu opened, navigating to first item');
              }
              break;
            case 'Escape':
              if (dropdown.classList.contains('dropdown-open')) {
                event.preventDefault();
                closeDropdown(dropdown, link, submenu);
                link.focus();
                announceToScreenReader('Submenu closed, returned to main menu');
              }
              break;
            case 'Home':
              // Focus first navigation item
              event.preventDefault();
              const firstNavLink = document.querySelector('.nav-link');
              if (firstNavLink) {
                firstNavLink.focus();
                announceToScreenReader('Moved to first navigation item');
              }
              break;
            case 'End':
              // Focus last navigation item
              event.preventDefault();
              const navLinks = document.querySelectorAll('.nav-link');
              const lastNavLink = navLinks[navLinks.length - 1];
              if (lastNavLink) {
                lastNavLink.focus();
                announceToScreenReader('Moved to last navigation item');
              }
              break;
          }
        });

        // Enhanced submenu keyboard navigation
        const submenuLinks = submenu.querySelectorAll('.nav-sublink');
        submenuLinks.forEach(function (submenuLink, index) {
          // Set tabindex for proper focus management
          submenuLink.setAttribute('tabindex', '-1');
          
          submenuLink.addEventListener('keydown', function (event) {
            switch (event.key) {
              case 'ArrowDown':
                event.preventDefault();
                const nextIndex = (index + 1) % submenuLinks.length;
                submenuLinks[nextIndex].focus();
                announceToScreenReader(`Item ${nextIndex + 1} of ${submenuLinks.length}`);
                break;
              case 'ArrowUp':
                event.preventDefault();
                const prevIndex = index === 0 ? submenuLinks.length - 1 : index - 1;
                submenuLinks[prevIndex].focus();
                announceToScreenReader(`Item ${prevIndex + 1} of ${submenuLinks.length}`);
                break;
              case 'ArrowLeft':
              case 'Escape':
                event.preventDefault();
                closeDropdown(dropdown, link, submenu);
                link.focus();
                announceToScreenReader('Returned to main menu');
                break;
              case 'Home':
                event.preventDefault();
                submenuLinks[0].focus();
                announceToScreenReader('Moved to first submenu item');
                break;
              case 'End':
                event.preventDefault();
                submenuLinks[submenuLinks.length - 1].focus();
                announceToScreenReader('Moved to last submenu item');
                break;
              case 'Tab':
                // Allow tab to move to next focusable element outside menu
                closeDropdown(dropdown, link, submenu);
                break;
            }
          });
          
          // Add focus and blur handlers for better UX
          submenuLink.addEventListener('focus', function() {
            submenuLink.setAttribute('tabindex', '0');
          });
          
          submenuLink.addEventListener('blur', function() {
            submenuLink.setAttribute('tabindex', '-1');
          });
        });
        
        // Mouse hover handling with delay for better UX
        let hoverTimeout;
        
        dropdown.addEventListener('mouseenter', function() {
          clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(() => {
            if (!dropdown.classList.contains('dropdown-open')) {
              openDropdown(dropdown, link, submenu);
            }
          }, 150); // Small delay to prevent accidental opens
        });
        
        dropdown.addEventListener('mouseleave', function() {
          clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(() => {
            if (dropdown.classList.contains('dropdown-open') && 
                !dropdown.contains(document.activeElement)) {
              closeDropdown(dropdown, link, submenu);
            }
          }, 300); // Longer delay for mouse users
        });
      }
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function (event) {
      const openDropdowns = document.querySelectorAll('.nav-item-dropdown.dropdown-open');
      openDropdowns.forEach(function (dropdown) {
        if (!dropdown.contains(event.target)) {
          const link = dropdown.querySelector('.nav-link[aria-haspopup="true"]');
          const submenu = dropdown.querySelector('.nav-submenu');
          closeDropdown(dropdown, link, submenu);
        }
      });

      // Mobile menu outside click handling is managed by mobile-navigation.js
    });

    // Global escape key handling
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        // Mobile menu escape handling is managed by mobile-navigation.js
        
        // Close all open dropdowns
        const openDropdowns = document.querySelectorAll('.nav-item-dropdown.dropdown-open');
        openDropdowns.forEach(function (dropdown) {
          const link = dropdown.querySelector('.nav-link[aria-haspopup="true"]');
          const submenu = dropdown.querySelector('.nav-submenu');
          closeDropdown(dropdown, link, submenu);
        });
      }
    });

    // Enhanced dropdown utility functions with accessibility support
    function toggleDropdown(dropdown, link, submenu) {
      if (dropdown.classList.contains('dropdown-open')) {
        closeDropdown(dropdown, link, submenu);
      } else {
        openDropdown(dropdown, link, submenu);
      }
    }

    function openDropdown(dropdown, link, submenu) {
      // Close other open dropdowns first
      const otherDropdowns = document.querySelectorAll('.nav-item-dropdown.dropdown-open');
      otherDropdowns.forEach(function (otherDropdown) {
        if (otherDropdown !== dropdown) {
          const otherLink = otherDropdown.querySelector('.nav-link[aria-haspopup="true"]');
          const otherSubmenu = otherDropdown.querySelector('.nav-submenu');
          closeDropdown(otherDropdown, otherLink, otherSubmenu);
        }
      });

      dropdown.classList.add('dropdown-open');
      link.setAttribute('aria-expanded', 'true');
      submenu.setAttribute('aria-hidden', 'false');
      
      // Update submenu items tabindex for keyboard navigation
      const submenuLinks = submenu.querySelectorAll('.nav-sublink');
      submenuLinks.forEach((item, index) => {
        item.setAttribute('tabindex', index === 0 ? '0' : '-1');
      });
      
      // Add visual indicator for screen readers
      const menuName = link.textContent.trim();
      announceToScreenReader(`${menuName} submenu opened with ${submenuLinks.length} items`);
    }

    function closeDropdown(dropdown, link, submenu) {
      dropdown.classList.remove('dropdown-open');
      link.setAttribute('aria-expanded', 'false');
      submenu.setAttribute('aria-hidden', 'true');
      
      // Reset submenu items tabindex
      const submenuLinks = submenu.querySelectorAll('.nav-sublink');
      submenuLinks.forEach(item => {
        item.setAttribute('tabindex', '-1');
      });
      
      // Announce closure to screen readers
      const menuName = link.textContent.trim();
      announceToScreenReader(`${menuName} submenu closed`);
    }

    function focusFirstSubmenuItem(submenu) {
      const firstLink = submenu.querySelector('.nav-sublink');
      if (firstLink) {
        firstLink.setAttribute('tabindex', '0');
        firstLink.focus();
        
        // Announce current position
        const submenuLinks = submenu.querySelectorAll('.nav-sublink');
        announceToScreenReader(`Focused on first item: ${firstLink.textContent.trim()}. ${submenuLinks.length} items total`);
      }
    }
    
    // Screen reader announcement utility
    function announceToScreenReader(message, priority = 'polite') {
      // Use the global accessibility manager if available
      if (window.accessibilityManager && window.accessibilityManager.announceToScreenReader) {
        window.accessibilityManager.announceToScreenReader(message, priority);
        return;
      }
      
      // Fallback: use live region directly
      let liveRegion = document.getElementById('live-region');
      if (!liveRegion) {
        liveRegion = document.createElement('div');
        liveRegion.id = 'live-region';
        liveRegion.setAttribute('aria-live', 'polite');
        liveRegion.setAttribute('aria-atomic', 'true');
        liveRegion.className = 'sr-only';
        document.body.appendChild(liveRegion);
      }
      
      liveRegion.setAttribute('aria-live', priority);
      liveRegion.textContent = message;
      
      // Clear after announcement
      setTimeout(() => {
        liveRegion.textContent = '';
      }, 1000);
    }
  });
</script>